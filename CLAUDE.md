# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

clarabel4j is a Java library providing bindings to the [Clarabel](https://clarabel.org) convex optimization solver via Java's Foreign Function and Memory (FFM) API. Requires JDK 25+.

## Build Commands

```bash
# Build and test
mvn clean verify

# Build with coverage
mvn -B clean verify -P coverage

# Run all tests
mvn test

# Run a single test class
mvn test -Dtest=ModelTest

# Run a single test method
mvn test -Dtest=ModelTest#solveLinearProgramReturnsExpectedSolution
```

## Architecture

**Problem formulation:** minimize `1/2 x'Px + q'x` subject to `Ax + s = b, s in K` (cone constraints).

### Core Classes (`com.ustermetrics.clarabel4j`)

- **Model** — Main entry point. Implements `AutoCloseable`; must be used with try-with-resources. Lifecycle stages: `NEW → SETUP → OPTIMIZED`. Manages native memory via FFM `Arena`.
- **Parameters** — Record with builder pattern (`Parameters.builder()...build()`). 39 solver configuration fields with validation in the canonical constructor.
- **Matrix** — Record for Compressed Sparse Column (CSC) sparse matrices. Fields: `m`, `n`, `colPtr`, `rowVal`, `nzVal`.
- **Cone** — Sealed abstract class with permits: `ZeroCone`, `NonnegativeCone`, `SecondOrderCone`, `ExponentialCone`, `PowerCone`, `GenPowerCone`.
- **Output** — Sealed interface with implementations: `StdOutOutput`, `StringOutput`, `FileOutput`.
- **Status** — Enum of solver result statuses (SOLVED, PRIMAL_INFEASIBLE, etc.).
- **DirectSolveMethod** — Enum (AUTO, QDLDL, FAER, PARDISO_MKL).

### Bindings (`com.ustermetrics.clarabel4j.bindings`)

Auto-generated by `jextract` from native C headers. Do not edit manually. Regenerate with `./bindings/generate.sh`. The `bindings/` package is excluded from code coverage.

## Key Patterns

- **Lombok** — Uses `@Builder`, `@Getter`, `@NonNull`, `val` throughout. Processed via annotation processor configured in pom.xml.
- **JPMS** — Module `com.ustermetrics.clarabel4j` defined in `src/main/java/module-info.java`.
- **Guava Preconditions** — `checkArgument`/`checkState` for validation.
- **Native access** — Tests require JVM flags `--enable-native-access=com.ustermetrics.clarabel4j --enable-native-access=org.scijava.nativelib` (configured in maven-surefire-plugin).
- **Platform-specific native libs** — Loaded via `native-lib-loader` from `clarabel4j-native` with classifiers `linux_64`, `windows_64`, `osx_arm64`. Maven profiles auto-select based on OS.

## Release Process

```bash
export VERSION=X.Y.Z
git checkout --detach HEAD
sed -i -E "s/<version>[0-9]+\-SNAPSHOT<\/version>/<version>$VERSION<\/version>/g" pom.xml
git commit -m "v$VERSION" pom.xml
git tag v$VERSION
git push origin v$VERSION
```

Triggers Maven Central publication via GitHub Actions.
